(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("@nguniversal/express-engine/schematics/install/utils", ["require", "exports", "@angular-devkit/schematics", "typescript", "@schematics/angular/utility/ast-utils"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    /**
     * @license
     * Copyright Google LLC All Rights Reserved.
     *
     * Use of this source code is governed by an MIT-style license that can be
     * found in the LICENSE file at https://angular.io/license
     */
    const schematics_1 = require("@angular-devkit/schematics");
    const ts = require("typescript");
    const ast_utils_1 = require("@schematics/angular/utility/ast-utils");
    function findAppServerModuleExport(host, mainPath) {
        const mainBuffer = host.read(mainPath);
        if (!mainBuffer) {
            throw new schematics_1.SchematicsException(`Main file (${mainPath}) not found`);
        }
        const mainText = mainBuffer.toString('utf-8');
        const source = ts.createSourceFile(mainPath, mainText, ts.ScriptTarget.Latest, true);
        const allNodes = ast_utils_1.getSourceNodes(source);
        let exportDeclaration = null;
        for (const node of allNodes) {
            let exportDeclarationNode = node;
            // Walk up the parent until ExportDeclaration is found.
            while (exportDeclarationNode && exportDeclarationNode.parent
                && exportDeclarationNode.parent.kind !== ts.SyntaxKind.ExportDeclaration) {
                exportDeclarationNode = exportDeclarationNode.parent;
            }
            if (exportDeclarationNode !== null &&
                exportDeclarationNode.parent !== undefined &&
                exportDeclarationNode.parent.kind === ts.SyntaxKind.ExportDeclaration) {
                exportDeclaration = exportDeclarationNode.parent;
                break;
            }
        }
        return exportDeclaration;
    }
    exports.findAppServerModuleExport = findAppServerModuleExport;
    function findAppServerModulePath(host, mainPath) {
        const exportDeclaration = findAppServerModuleExport(host, mainPath);
        if (!exportDeclaration) {
            throw new schematics_1.SchematicsException('Could not find app server module export');
        }
        const moduleSpecifier = exportDeclaration.moduleSpecifier.getText();
        return moduleSpecifier.substring(1, moduleSpecifier.length - 1);
    }
    exports.findAppServerModulePath = findAppServerModulePath;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9tb2R1bGVzL2V4cHJlc3MtZW5naW5lL3NjaGVtYXRpY3MvaW5zdGFsbC91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztJQUFBOzs7Ozs7T0FNRztJQUNILDJEQUF1RTtJQUN2RSxpQ0FBaUM7SUFDakMscUVBQXFFO0lBRXJFLFNBQWdCLHlCQUF5QixDQUFDLElBQVUsRUFDVixRQUFnQjtRQUN4RCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixNQUFNLElBQUksZ0NBQW1CLENBQUMsY0FBYyxRQUFRLGFBQWEsQ0FBQyxDQUFDO1NBQ3BFO1FBQ0QsTUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5QyxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVyRixNQUFNLFFBQVEsR0FBRywwQkFBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXhDLElBQUksaUJBQWlCLEdBQWdDLElBQUksQ0FBQztRQUUxRCxLQUFLLE1BQU0sSUFBSSxJQUFJLFFBQVEsRUFBRTtZQUUzQixJQUFJLHFCQUFxQixHQUFtQixJQUFJLENBQUM7WUFFakQsdURBQXVEO1lBQ3ZELE9BQU8scUJBQXFCLElBQUkscUJBQXFCLENBQUMsTUFBTTttQkFDekQscUJBQXFCLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxFQUFFLENBQUMsVUFBVSxDQUFDLGlCQUFpQixFQUFFO2dCQUN4RSxxQkFBcUIsR0FBRyxxQkFBcUIsQ0FBQyxNQUFNLENBQUM7YUFDdEQ7WUFFRCxJQUFJLHFCQUFxQixLQUFLLElBQUk7Z0JBQ2hDLHFCQUFxQixDQUFDLE1BQU0sS0FBSyxTQUFTO2dCQUMxQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLEVBQUUsQ0FBQyxVQUFVLENBQUMsaUJBQWlCLEVBQUU7Z0JBQ3ZFLGlCQUFpQixHQUFHLHFCQUFxQixDQUFDLE1BQThCLENBQUM7Z0JBQ3pFLE1BQU07YUFDUDtTQUNGO1FBRUQsT0FBTyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDO0lBaENELDhEQWdDQztJQUVELFNBQWdCLHVCQUF1QixDQUFDLElBQVUsRUFBRSxRQUFnQjtRQUNsRSxNQUFNLGlCQUFpQixHQUFHLHlCQUF5QixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDdEIsTUFBTSxJQUFJLGdDQUFtQixDQUFDLHlDQUF5QyxDQUFDLENBQUM7U0FDMUU7UUFFRCxNQUFNLGVBQWUsR0FBRyxpQkFBaUIsQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDcEUsT0FBTyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFSRCwwREFRQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuaW1wb3J0IHsgU2NoZW1hdGljc0V4Y2VwdGlvbiwgVHJlZSB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9zY2hlbWF0aWNzJztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuaW1wb3J0IHtnZXRTb3VyY2VOb2Rlc30gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L2FzdC11dGlscyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kQXBwU2VydmVyTW9kdWxlRXhwb3J0KGhvc3Q6IFRyZWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluUGF0aDogc3RyaW5nKTogdHMuRXhwb3J0RGVjbGFyYXRpb24gfCBudWxsIHtcbiAgY29uc3QgbWFpbkJ1ZmZlciA9IGhvc3QucmVhZChtYWluUGF0aCk7XG4gIGlmICghbWFpbkJ1ZmZlcikge1xuICAgIHRocm93IG5ldyBTY2hlbWF0aWNzRXhjZXB0aW9uKGBNYWluIGZpbGUgKCR7bWFpblBhdGh9KSBub3QgZm91bmRgKTtcbiAgfVxuICBjb25zdCBtYWluVGV4dCA9IG1haW5CdWZmZXIudG9TdHJpbmcoJ3V0Zi04Jyk7XG4gIGNvbnN0IHNvdXJjZSA9IHRzLmNyZWF0ZVNvdXJjZUZpbGUobWFpblBhdGgsIG1haW5UZXh0LCB0cy5TY3JpcHRUYXJnZXQuTGF0ZXN0LCB0cnVlKTtcblxuICBjb25zdCBhbGxOb2RlcyA9IGdldFNvdXJjZU5vZGVzKHNvdXJjZSk7XG5cbiAgbGV0IGV4cG9ydERlY2xhcmF0aW9uOiB0cy5FeHBvcnREZWNsYXJhdGlvbiB8IG51bGwgPSBudWxsO1xuXG4gIGZvciAoY29uc3Qgbm9kZSBvZiBhbGxOb2Rlcykge1xuXG4gICAgbGV0IGV4cG9ydERlY2xhcmF0aW9uTm9kZTogdHMuTm9kZSB8IG51bGwgPSBub2RlO1xuXG4gICAgLy8gV2FsayB1cCB0aGUgcGFyZW50IHVudGlsIEV4cG9ydERlY2xhcmF0aW9uIGlzIGZvdW5kLlxuICAgIHdoaWxlIChleHBvcnREZWNsYXJhdGlvbk5vZGUgJiYgZXhwb3J0RGVjbGFyYXRpb25Ob2RlLnBhcmVudFxuICAgICYmIGV4cG9ydERlY2xhcmF0aW9uTm9kZS5wYXJlbnQua2luZCAhPT0gdHMuU3ludGF4S2luZC5FeHBvcnREZWNsYXJhdGlvbikge1xuICAgICAgZXhwb3J0RGVjbGFyYXRpb25Ob2RlID0gZXhwb3J0RGVjbGFyYXRpb25Ob2RlLnBhcmVudDtcbiAgICB9XG5cbiAgICBpZiAoZXhwb3J0RGVjbGFyYXRpb25Ob2RlICE9PSBudWxsICYmXG4gICAgICBleHBvcnREZWNsYXJhdGlvbk5vZGUucGFyZW50ICE9PSB1bmRlZmluZWQgJiZcbiAgICAgIGV4cG9ydERlY2xhcmF0aW9uTm9kZS5wYXJlbnQua2luZCA9PT0gdHMuU3ludGF4S2luZC5FeHBvcnREZWNsYXJhdGlvbikge1xuICAgICAgZXhwb3J0RGVjbGFyYXRpb24gPSBleHBvcnREZWNsYXJhdGlvbk5vZGUucGFyZW50IGFzIHRzLkV4cG9ydERlY2xhcmF0aW9uO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGV4cG9ydERlY2xhcmF0aW9uO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZEFwcFNlcnZlck1vZHVsZVBhdGgoaG9zdDogVHJlZSwgbWFpblBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IGV4cG9ydERlY2xhcmF0aW9uID0gZmluZEFwcFNlcnZlck1vZHVsZUV4cG9ydChob3N0LCBtYWluUGF0aCk7XG4gIGlmICghZXhwb3J0RGVjbGFyYXRpb24pIHtcbiAgICB0aHJvdyBuZXcgU2NoZW1hdGljc0V4Y2VwdGlvbignQ291bGQgbm90IGZpbmQgYXBwIHNlcnZlciBtb2R1bGUgZXhwb3J0Jyk7XG4gIH1cblxuICBjb25zdCBtb2R1bGVTcGVjaWZpZXIgPSBleHBvcnREZWNsYXJhdGlvbi5tb2R1bGVTcGVjaWZpZXIuZ2V0VGV4dCgpO1xuICByZXR1cm4gbW9kdWxlU3BlY2lmaWVyLnN1YnN0cmluZygxLCBtb2R1bGVTcGVjaWZpZXIubGVuZ3RoIC0gMSk7XG59XG4iXX0=